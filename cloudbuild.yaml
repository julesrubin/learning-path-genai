substitutions:
  _SERVICES_TO_BUILD: 'genai-api'
  _REGION: 'europe-west1'

steps:
  # Project initialization - creates tfstate bucket if needed
  - id: 'project-init'
    name: gcr.io/cloud-builders/gcloud
    entrypoint: sh
    args:
      - '-c'
      - |
        echo "***********************"
        echo "project           : $PROJECT_ID"
        echo "branch            : $BRANCH_NAME"
        echo "***********************"
        cd iac/init
        chmod +x init.sh
        ./init.sh ${PROJECT_ID}

  # Build and push Docker images for Cloud Run services
  - id: 'docker-build-push'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -z "${_SERVICES_TO_BUILD}" ]; then
          echo "No services to build (_SERVICES_TO_BUILD is empty). Skipping..."
          exit 0
        fi

        REPO="${_REGION}-docker.pkg.dev/${PROJECT_ID}/${PROJECT_ID}-gcr-learning-path-genai"

        for SERVICE in ${_SERVICES_TO_BUILD}; do
          echo "========================================"
          echo "Building and pushing: $${SERVICE}"
          echo "========================================"
          docker build -t "$${REPO}/$${SERVICE}:latest" -t "$${REPO}/$${SERVICE}:${SHORT_SHA}" "cloud_run/$${SERVICE}"
          docker push "$${REPO}/$${SERVICE}" --all-tags
        done

  # Terraform init
  - id: 'terraform-init'
    name: 'hashicorp/terraform:1.14.1'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd iac
        terraform init -input=false -no-color -upgrade -backend-config=init/backend.tfvars

  # Terraform plan
  - id: 'terraform-plan'
    name: 'hashicorp/terraform:1.14.1'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd iac
        terraform plan -out=changes.tfplan -var project_id=$PROJECT_ID

  # Terraform apply
  - id: 'terraform-apply'
    name: 'hashicorp/terraform:1.14.1'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd iac
        terraform apply -input=false -no-color -auto-approve changes.tfplan

timeout: 5400s
options:
  logging: CLOUD_LOGGING_ONLY
serviceAccount: 'projects/$PROJECT_ID/serviceAccounts/build-learning-path-sa@$PROJECT_ID.iam.gserviceaccount.com'
